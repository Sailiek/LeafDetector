<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaf Processing Stages</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .parameter-group {
            margin: 10px 0;
        }
        .parameter-group label {
            display: block;
            margin-bottom: 5px;
        }
        .parameter-group input[type="range"] {
            width: 200px;
            margin-right: 10px;
        }
        .parameter-group output {
            display: inline-block;
            min-width: 30px;
        }
    </style>
</head>
<body>
    <h1>Image Processing Stages</h1>

    <div class="original-image">
        <h3>Original Image</h3>
        <img src="{{ url_for('uploaded_file', filename=filename) }}" alt="Original Image" width="300">
    </div>

    <form id="processing-form">
        <!-- Noise Cleaning Stage -->
        <div class="stage-container">
            <div class="stage-inputs">
                <h3>Stage 2: Noise Cleaning</h3>
                <label for="noise_cleaning">Choose a filter:</label>
                <select id="noise_cleaning" name="noise_cleaning">
                    <option value="none">None</option>
                    <option value="linear">Linear Filters</option>
                    <option value="nonlinear">Non-Linear Filters</option>
                </select>
                
                <!-- Linear filters options (initially hidden) -->
                <div id="linear_filters" style="display: none;">
                    <label for="linear_filter_type">Choose linear filter:</label>
                    <select id="linear_filter_type" name="linear_filter_type">
                        <option value="gaussian">Gaussian Filter</option>
                        <option value="mean">Mean Filter</option>
                        <option value="laplacian">Laplacian Filter</option>
                        <option value="butterworth">Butterworth Filter</option>
                    </select>
                </div>

                <!-- Non-linear filters options (initially hidden) -->
                <div id="nonlinear_filters" style="display: none;">
                    <label for="nonlinear_filter_type">Choose non-linear filter:</label>
                    <select id="nonlinear_filter_type" name="nonlinear_filter_type">
                        <option value="median">Median Filter</option>
                        <option value="bilateral">Bilateral Filter</option>
                        <option value="nlm">Non-Local Means Filter</option>
                        <option value="adaptive_median">Adaptive Median Filter</option>
                    </select>
                </div>
            </div>
            <div class="stage-preview" id="noise-cleaning-preview">
                <div class="preview-placeholder">Preview will appear here after processing</div>
            </div>
        </div>

        <!-- Edge Detection Stage -->
        <div class="stage-container">
            <div class="stage-inputs">
                <h3>Stage 3: Edge Detection</h3>
                <label for="edge_detection">Choose an algorithm:</label>
                <select id="edge_detection" name="edge_detection">
                    <option value="canny">Canny</option>
                    <option value="sobel">Sobel</option>
                    <option value="prewitt">Prewitt</option>
                    <option value="log">LoG</option>
                </select>
            </div>
            <div class="stage-preview" id="edge-detection-preview">
                <div class="preview-placeholder">Preview will appear here after processing</div>
            </div>
        </div>

        <!-- Segmentation Stage -->
        <div class="stage-container">
            <div class="stage-inputs">
                <h3>Stage 4: Segmentation</h3>
                <label for="segmentation">Choose a segmentation method:</label>
                <select id="segmentation" name="segmentation">
                    <option value="thresholding">Thresholding</option>
                    <option value="active-contours">Active Contours</option>
                </select>
                
                <!-- Parameters for segmentation -->
                <div id="segmentation_parameters" style="display: none;">
                    <!-- Parameters for thresholding -->
                    <div id="thresholding_params" style="display: none;">
                        <div class="parameter-group">
                            <label for="block_size">Block Size (3-99):</label>
                            <input type="range" id="block_size" name="block_size" min="3" max="99" step="2" value="35"
                                   oninput="this.nextElementSibling.value = this.value">
                            <output>35</output>
                        </div>
                        <div class="parameter-group">
                            <label for="c_value">C Value (-10 to 20):</label>
                            <input type="range" id="c_value" name="c_value" min="-10" max="20" value="5"
                                   oninput="this.nextElementSibling.value = this.value">
                            <output>5</output>
                        </div>
                    </div>
                    
                    <!-- Parameters for active contours -->
                    <div id="contours_params" style="display: none;">
                        <div class="parameter-group">
                            <label for="alpha">Alpha (0-0.1):</label>
                            <input type="range" id="alpha" name="alpha" min="0" max="100" value="10"
                                   oninput="this.nextElementSibling.value = this.value/1000">
                            <output>0.01</output>
                        </div>
                        <div class="parameter-group">
                            <label for="beta">Beta (0-0.5):</label>
                            <input type="range" id="beta" name="beta" min="0" max="500" value="100"
                                   oninput="this.nextElementSibling.value = this.value/1000">
                            <output>0.1</output>
                        </div>
                        <div class="parameter-group">
                            <label for="iterations">Iterations (50-500):</label>
                            <input type="range" id="iterations" name="iterations" min="50" max="500" value="200"
                                   oninput="this.nextElementSibling.value = this.value">
                            <output>200</output>
                        </div>
                    </div>
                </div>
            </div>
            <div class="stage-preview" id="segmentation-preview">
                <div class="preview-placeholder">Preview will appear here after processing</div>
            </div>
        </div>

        <!-- Contour Refinement Stage -->
        <div class="stage-container">
            <div class="stage-inputs">
                <h3>Stage 5: Contour Refinement</h3>
                <label for="contour_refinement">Choose a refinement method:</label>
                <select id="contour_refinement" name="contour_refinement">
                    <option value="none">None</option>
                    <option value="morphological">Morphological Operations</option>
                    <option value="enhancement">Enhancement</option>
                </select>

                <!-- Parameters for contour refinement -->
                <div id="contour_parameters" style="display: none;">
                    <div class="parameter-group">
                        <label for="threshold">Threshold (0-255):</label>
                        <input type="range" id="threshold" name="threshold" min="0" max="255" value="127" 
                               oninput="this.nextElementSibling.value = this.value">
                        <output>127</output>
                    </div>

                    <!-- Parameters for morphological operations -->
                    <div id="morphological_params" style="display: none;">
                        <div class="parameter-group">
                            <label for="kernel_size">Kernel Size (3-15):</label>
                            <input type="range" id="kernel_size" name="kernel_size" min="3" max="15" step="2" value="5"
                                   oninput="this.nextElementSibling.value = this.value">
                            <output>5</output>
                        </div>
                        <div class="parameter-group">
                            <label for="iterations">Iterations (1-5):</label>
                            <input type="range" id="iterations" name="iterations" min="1" max="5" value="1"
                                   oninput="this.nextElementSibling.value = this.value">
                            <output>1</output>
                        </div>
                    </div>

                    <!-- Parameters for enhancement -->
                    <div id="enhancement_params" style="display: none;">
                        <div class="parameter-group">
                            <label for="min_area">Minimum Area (50-500):</label>
                            <input type="range" id="min_area" name="min_area" min="50" max="500" value="100"
                                   oninput="this.nextElementSibling.value = this.value">
                            <output>100</output>
                        </div>
                        <div class="parameter-group">
                            <label for="max_complexity">Max Complexity (10-100):</label>
                            <input type="range" id="max_complexity" name="max_complexity" min="10" max="100" value="50"
                                   oninput="this.nextElementSibling.value = this.value">
                            <output>50</output>
                        </div>
                    </div>
                </div>
            </div>
            <div class="stage-preview" id="contour-refinement-preview">
                <div class="preview-placeholder">Preview will appear here after processing</div>
            </div>
            <div id="detection-results" style="display: none;">
                <h4>Plant Detection Results:</h4>
                <p>Plant Type: <span id="plant-type"></span></p>
                <p>Confidence: <span id="confidence"></span></p>
            </div>
        </div>

        <button type="submit">Finalize Processing</button>
    </form>

    <script>
        // Function to update preview for a specific stage
        function updatePreview(stageId, imageUrl) {
            const previewDiv = document.getElementById(stageId + '-preview');
            // Clear existing content
            previewDiv.innerHTML = '';
            // Create and add new image
            const img = document.createElement('img');
            img.src = imageUrl + '?t=' + new Date().getTime(); // Add timestamp to prevent caching
            img.alt = 'Processed Image';
            previewDiv.appendChild(img);
        }

        // Function to process a stage
        function processStage(stageId) {
            const formData = new FormData();
            formData.append('stage', stageId);
            formData.append(stageId, document.getElementById(stageId).value);
            
            // Add contour refinement parameters if applicable
            if (stageId === 'contour_refinement' && document.getElementById(stageId).value !== 'none') {
                formData.append('threshold', document.getElementById('threshold').value);
                
                if (document.getElementById(stageId).value === 'morphological') {
                    formData.append('kernel_size', document.getElementById('kernel_size').value);
                    formData.append('iterations', document.getElementById('iterations').value);
                } else if (document.getElementById(stageId).value === 'enhancement') {
                    formData.append('min_area', document.getElementById('min_area').value);
                    formData.append('max_complexity', document.getElementById('max_complexity').value);
                }
            }
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                updatePreview(stageId.replace('_', '-'), '/uploads/' + data.processed_image);
                
                // Handle plant detection results
                if (data.detection) {
                    const detectionDiv = document.getElementById('detection-results');
                    detectionDiv.style.display = 'block';
                    document.getElementById('plant-type').textContent = data.detection.plant_type;
                    document.getElementById('confidence').textContent = data.detection.confidence;
                } else {
                    document.getElementById('detection-results').style.display = 'none';
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Add change event listeners to all select elements
        document.getElementById('noise_cleaning').addEventListener('change', function() {
            const linearFilters = document.getElementById('linear_filters');
            const nonlinearFilters = document.getElementById('nonlinear_filters');
            
            // Hide both filter type divs initially
            linearFilters.style.display = 'none';
            nonlinearFilters.style.display = 'none';
            
            // Show appropriate filter type div based on selection
            if (this.value === 'linear') {
                linearFilters.style.display = 'block';
            } else if (this.value === 'nonlinear') {
                nonlinearFilters.style.display = 'block';
            }
            
            processStage('noise_cleaning');
        });

        // Add listeners for sub-filter changes
        document.getElementById('linear_filter_type').addEventListener('change', function() {
            processStage('noise_cleaning');
        });

        document.getElementById('nonlinear_filter_type').addEventListener('change', function() {
            processStage('noise_cleaning');
        });

        document.getElementById('edge_detection').addEventListener('change', function() {
            processStage('edge_detection');
        });

        document.getElementById('segmentation').addEventListener('change', function() {
            const paramsDiv = document.getElementById('segmentation_parameters');
            const thresholdingParams = document.getElementById('thresholding_params');
            const contoursParams = document.getElementById('contours_params');
            
            // Hide all parameter divs initially
            paramsDiv.style.display = 'none';
            thresholdingParams.style.display = 'none';
            contoursParams.style.display = 'none';
            
            // Show appropriate parameter divs based on selection
            if (this.value === 'thresholding') {
                paramsDiv.style.display = 'block';
                thresholdingParams.style.display = 'block';
            } else if (this.value === 'active-contours') {
                paramsDiv.style.display = 'block';
                contoursParams.style.display = 'block';
            }
            
            processStage('segmentation');
        });

        // Add listeners for segmentation parameter changes
        ['block_size', 'c_value', 'alpha', 'beta', 'iterations'].forEach(param => {
            const element = document.getElementById(param);
            if (element) {
                element.addEventListener('input', function() {
                    processStage('segmentation');
                });
            }
        });

        document.getElementById('contour_refinement').addEventListener('change', function() {
            const paramsDiv = document.getElementById('contour_parameters');
            const morphologicalParams = document.getElementById('morphological_params');
            const enhancementParams = document.getElementById('enhancement_params');
            
            // Hide all parameter divs initially
            paramsDiv.style.display = 'none';
            morphologicalParams.style.display = 'none';
            enhancementParams.style.display = 'none';
            
            // Show appropriate parameter divs based on selection
            if (this.value !== 'none') {
                paramsDiv.style.display = 'block';
                if (this.value === 'morphological') {
                    morphologicalParams.style.display = 'block';
                } else if (this.value === 'enhancement') {
                    enhancementParams.style.display = 'block';
                }
            }
            
            processStage('contour_refinement');
        });

        // Add listeners for parameter changes
        ['threshold', 'kernel_size', 'iterations', 'min_area', 'max_complexity'].forEach(param => {
            document.getElementById(param).addEventListener('input', function() {
                processStage('contour_refinement');
            });
        });

        // Prevent form submission
        document.getElementById('processing-form').addEventListener('submit', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
